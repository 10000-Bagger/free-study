# Slash 요약

## **토스뱅크의 완전히 새로운 대출 시스템**

| 문제 | 해결책 |
| --- | --- |
| 모놀리틱 구조로 신규 피처 개발 시 영향도 분석에 시간이 많이 소비된다 | MSA 환경 구성. 비즈니스 로직 개별 서비스에서 관리 |
| MSA 환경에서 독립된 스키마를 가지게 되어 관리 문제 발생 | • flyway: DB 형상 관리 툴. GIT으로 SQL문 관리 가능 <br> ◦ 브랜치에 반영하면 해당 DB에 반영 <br><br> • hibernate validate 옵션: entity와 스키마 확인 |
| 토스의 요청량과 동일하게 대외기관에 요청하면 대외기관 서버 터짐 | • kafka 도입해서 토스에서 발생한 연동 요청과 실제 대외 기관에 요청하는 파트를 분리 <br> • 유량 제어 시스템 도입: <br> ◦ 대외 기관의 심사 시간과 TPS 증가 여부와 같은 통계 지표를 Redis/MYSQL에 저장 <br> ◦ 실패율과 응답 시간이 늘어나면 Thread Pool 조절하여 대외 기관이 견딜 수 있을 만큼만 요청 <br> ◦ 실패율이 너무 커진다면 앱 스크래핑 전략으로 변환 <br> • TPS가 특정치 이상 증가하면 대기열 시스템 가동 |

## **새로운 은행을 위한 Modern 대외 연계 시스템(FEP) 구축기**

FEP: 계정계와 대외 기관이 통신할 때 사용하는 시스템

| 문제 | 해결책 |
| --- | --- |
| 외부 업체 FEP를 사용할 경우 안정성 측면 한계 <br> • Blocking I/O만을 지원한다. → 대외 기관 응답 지연 시 Thread 부족 현상 <br> • FEP 1개의 인스턴스가 여러 업무를 처리하는데, 장애 전파 가능해짐 | • WebFlux / WebClient를 활용한 Non Blocking I/O 활용 <br> • 대외업무 별로 FEP를 분리해 별도 인스턴스로 운영 (장애 전파 예방) → MSA 느낌 |
| FEP와 대외 기관의 연동에서 요청과 응답은 다른 세션을 사용한다. <br> 때문에 FEP를 Active-Active로 구성할 경우 Service의 요청에 응답을 못할 수 있다. | 대외 기관의 응답 데이터를 Service의 HTTP 요청에 대한 응답으로 주는 것이 아니라 Redis에 데이터 저장하고, Service는 Redis에서 데이터를 기다린다. <br><br> Redis Set은 Poll 방식 |

## **왜 은행은 무한스크롤이 안되나요**

모놀리식 구조의 장단

- 트랜잭션 처리 유리
- 특정 서버만 스케일 아웃 / DB 분리 선택 불가능

MSA의 장단

- 네트워크가 복잡하고 DB 여럿
- 경우에 따라 트랜잭션 처리가 어려울 수 있다.
- 특정 서버에 부하가 몰리면 그것만 스케일 아웃 가능
- DB 부하가 커지면 DB 분리 선택 가능

| 문제 | 해결책 |
| --- | --- |
| 거래 내역을 무한 스크롤로 조회하고 싶지만 이는 코어 뱅킹 시스템에 부하를 준다. | • 채널계에 송금 내역 데이터를 저장하고 이 데이터를 바탕으로 거래 내역을 제공한다. <br> • 코어 뱅킹에서 거래 내역을 Kafka Produce한다. |
| 송금 시 채널계에서는 TIMEOUT 계정계에서는 송금 성공이라면? | • 코어 뱅킹에서 거래 내역을 Kafka Produce하기 때문에 채널계 송금 DB에 저장될 수 있다. |
| TIMEOUT 시 유저가 실패한 줄 알고 다시 송금할 수 있다. | • 코어 뱅킹에 요청 전에 송금 DB에 데이터를 송금 진행중으로 저장한다 <br> • 때문에 진행중인 송금이 있을 경우 송금은 실패시킨다. <br> • 송금 진행중인 건들의 경우 주기적으로 채널계에 송금 완료 여부를 확인한다. |
| Kafka Consume의 저장 실패 | Retry + DLQ |
| 동기화 순서가 다를 경우 거래 내역 조회 시 - 통장을 만날 수 있다 | 거래 내역 Message Consume 시 이전에 다른 거래가 있었는지 코어 뱅킹 서버에 조회를 한다. |
| 대량 거래 내역으로 동기화가 지연되면? | Partition 기준 병렬 처리 + 워커 스레드를 활용 (같은 계좌 같은 워커 스레드가 할당 받도록) |
| 최후의 수단 | 유저가 직접 거래 내역 최신화 |
