# 지표 모니터링 및 경보 시스템
잘 설계된 지표 모니터링 및 경보 시스템은 인프라의 상태를 선명하게 볼 수 있도록 돕는다. (Observability) <br>
결과적으로 높은 가용성과 안정성을 달성하는 데 중추적인 역할을 한다.

<br>

# 1. 명세 파악하기
구체적인 설계에 앞서, 문제를 확실히 이해하고 설계 범위를 확정해야 한다. <br>
예를 들어 지금 우리 서비스에 필요한 것은 인프라 지표인데, error log나 access log에 초점을 맞춘 시스템을 만들어버리면 매우 곤란해진다. <Br>

1. 대규모 인프라를 모니터링 해야 함
   - 일간 능동 사용자 수 1억 명 (100million)
   - 서버 풀 1,000개, 풀당 서버 갯수 100개, 서버당 100개의 운영 지표를 수집한다고 치면 모니터링 해야 하는 지표의 수는 천만 개 수준
   - 데이터 보관 기간은 1년
   - 수집한 그대로 데이터를 보관하는 기간 : 1주일
   - 그 뒤에는 1분 단위 데이터로 변환한 후에 30일간 보관
   - 그 뒤에는 1시간 단위 데이터로 변환한 뒤 1년간 보관
2. 모니터링할 지표 예시 다음과 같은 것이 있음
   - CPU 사용률
   - 요청 수
   - 메모리 사용량
   - 메시지 큐 내의 메시지 수
3. 비기능 요구사항
   - 규모 확장성: 시스템은 늘어나는 지표 수와 경보의 양에 맞게 확장될 수 있어야 한다.
   - 낮은 응답 지연: dashboard 와 alert를 신속하게 처리할 수 있도록, query에 대한 낮은 응답 지연을 보장해야 한다.
   - 안정성: 높은 안정성을 제공하여 중요 경보를 놓치지 않도록 해야한다.
   - 유연성: 기술의 변화에 맡게 신기술을 도입할 수 있도록 유연한 파이프라인을 구축해야 한다.
4. 고려하지 않아도 되는 요구사항
   - Log Monitoring: 로그를 모니터링하기 위한 시스템은 일단 고려하지 말라. Elasticsearch, Logstash, Kibana -> 그 유명한 ELK 스택이 로그 모니터링이 용도로 널리 사용되고 있다.
   - Distributed System Tracing: 서비스에 대한 요청이 분산 시스템 내부를 어떻게 흘러 다니는지 추적할 수 있도록 하는 시스템. 요청이 서비스 사이에서 이동할 때마다 수집한다.


# 2. 설계안 제시
### 2.1 지표 모니터링 컴포넌트
지표 모니터링 및 경보 시스템은 기본적으로 아래와 같은 다섯가지 컴포넌트가 필요하다.

<br>

![개략적 설계안](https://github.com/10000-Bagger/free-topic-study/assets/71186266/2014a3b1-d340-4e9c-9990-89f7e6f114e9)

1. 데이터 수집 컴포넌트 : 여러 Source로 부터 지표 데이터 수집
2. 데이터 전송 컴포넌트 : 수집한 지표 데이터를 모니터링 시스템으로 전송
3. 데이터 저장소 컴포넌트 : 전송되어 오는 데이터를 정리하고 저장
4. 경보 컴포넌트 : 데이터를 분석하고, 이상 징후를 감지한 다음 경보를 발생시킨다. 개발자들이 빠른 대응을 하게 하려면 경보가 중요하다.
5. 시각화 컴포넌트 : 데이터를 차트나 그래프 등으로 시각화해서 제공해준다. 


### 2.2 지표 데이터 모델
지표 데이터는 통상 시계열 데이터로 저장된다. 시계열 각각은 보통 `고유한 지표 이름`, `지표 값 혹은 타임스탬프의 배열`, 그리고 선택적으로 `레이블`을 붙이기도 한다. <br>
이러한 시계열 데이터는 거의 실시간 수집되므로, 엄청난 쓰기 부하가 일어날 수 밖에 없다. 이번 요구사항은 무려 매일 천만개에 달하는 운영 지표가 쌓인다. <br> <br>
**즉, 우리가 평소에 DB에 쌓는 데이터들의 패턴과는 다르다!** <br>
우리가 평소에 쌓는 데이터들은 쓰기 부하 보다는 읽기 부하가 많은게 보통이다. 그리고 연관관계가 없다는 점도 다르다. <br>
읽기 패턴도 조금 다른데, 시각화 컴포넌트나 경보 컴포넌트가 데이터를 읽을 때나 한순간 Spiky하게 쭉 치솟았다가 잠잠해진다. 

### 2.3 데이터 저장소 시스템
데이터 저장소 시스템은 본 설계의 핵심과도 같다. <br>
시계열 데이터는 기존의 데이터들과는 성격이 다른 만큼, **우리가 평소에 사용하던 범용 RDB나 NoSQL은 저장소로써 적합하지 않다.** <br> <br>
RDB는 통상적으로 시계열 데이터를 다루지 않기 때문에, 높은 쓰기 부하의 시계열 데이터에 맞게 사용하려면 전문가 수준의 튜닝이 필요하다. 지속적이고 반복되는 쓰기 부하는 범용 RDB를 불안하게 만들어요~ 좋은 성능을 보이지 못한다. <br> 
또한, 지표 데이터는 그 특성상 다양한 통계 기능이 요구된다. 예를 들어 지수 이동 평균 값을 계속해서 갱신해야 한다고 생각해보자. 이걸 SQL Query로 짜기에는 너무 복잡하다. <br> <br>
NoSQL 또한 적합하지 않다. 시계열 데이터를 효율적으로 처리할 수 있다고 알려진 NoSQL들이 있기는 한데, (ex 카산드라, Bigtable) 이런 NoSQL들에 시계열 데이터를 효과적으로 저장하고 Query하기 위해서는 NoSQL 내부 구조에 대한 해박한 지식이 필요하다고 한다. <Br>

### 그럼 뭘 쓰라고?;
-> 시계열 데이터 전용 DB가 많다^^ <br>
시계열 데이터 전용 DB는 최적화가 아주 잘 되어 있어서, 같은 용량에도 더 많은 데이터를 저장할 수 있다. <br>
그리고 SQL 보다 사용하기 쉬운 Query 인터페이스를 제공해줘서 앞서 언급했던 통계 데이터 쿼리도 좋다. 그리고 데이터 보관 기간이나, 집계 설정도 간단하다. <br>
예시 서비스들은 아래와 같다. 간단하게 한번씩 알아봐야겠다.

1. OpenTSDB : 하둡, HBase 기반 분산 시계열 DB
2. MetricDB : X가 쓰고 있는 제품
3. Timestream : 아마존이 쓰고 있다.
4. InfluxDB : 가장 인기있는 시계열 DB이고, 시계열 DB를 한글로 검색했을 떄도 가장 결과가 많이 나왔다.
5. Prometheus : 대황 프로메테우스.. 나도 쓰고 있는데 아주 요물이다. 다량의 시계열 데이터를 저장하고 빠른 실시간 분석이 가능하다.
-> InfluxDB와 Promethus는 메모리 캐시와 디스크 저장소를 함께 사용하고, 높은 성능 요구사항과 Durabilty 요건을 만족한다. <br>
InfluxDB는 서버 한 대로도 초당 250,000회의 쓰기 연산이 가능하다고 한다. <br> <br>
