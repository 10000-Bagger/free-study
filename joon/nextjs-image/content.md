# NextJS의 Image 최적화

## Next/Image의 기능

`Next/Image`가 제공하는 대표적인 기능들은 다음과 같다.

- Size Optimization : `WebP` 및 `AVIF`와 같은 최신 이미지 형식을 사용해 각 장치에 대해 적절한 사이즈의 이미지를 제공한다.
- Visual Stability : `Layout Shift` 방지
- Faster Page Loads : 선택적으로 `placeholder`를 사용할 수 있고, `Lazy Loading`을 사용하여 화면에 이미지가 보일때 로딩한다.
- Asset Flexibility : 원격 서버에 저장된 이미지에 대해서도 이미지 크기 조정이 가능하다.

## Size Optimization

Next/Image는 디바이스 크기 별로 srcSet을 미리 지정해두고, 사용자의 디바이스에 맞는 이미지를 다운로드할 수 있게 지원한다.<br/>
Next.js는 이미지를 webp와 같은 용량이 작은 포맷으로 이미지를 변환해서 제공한다.<br/>
(이때 NextJS가 사용하는 라이브러리는 `sharp`이다.)

사용자의 디바이스에 맞는 이미지 사이즈를 만들고, 용량이 작은 WebP 포맷으로 변환하는 작업은 이미지에 대한 최초 요청 시에 Next.js 서버에서 진행된다.<br/>
이후 요청에는 캐시가 만료될 때까지 캐시 된 이미지가 제공되기 때문에 첫 번째 요청보다 훨씬 빠르게 이미지를 서빙할 수 있다.<br/>
캐시가 만료된 후 요청이 들어오면 오래된 이미지를 우선 제공하고, 백그라운드에서 이미지 최적화를 다시 진행한다.

이게 진짜 사실인지 알아보자.<br/>
이번 디프만 홈페이지를 만들며 사용한 반디부디 최종 발표 사진은 `129kB`이다.<br/>
하지만 Next/Image를 사용하며 `WebP`로 변환되었고, 이에 따른 용량은 무려 `42B`이다.<br/>
무려 **약 3배**나 줄어 엄청난 최적화를 이뤘다.

| 원본                             | Next/Image                        |
| -------------------------------- | --------------------------------- |
| <img src="./1.png" width="400"/> | <img src="./2.webp" width="400"/> |

`WebP`보다 `AVIF`를 사용한다면 이미지의 용량을 더 줄일 수 있다고 한다.<br/>
하지만 이는 `next.config,js`에서 추가적인 설정이 필요하고 일부 지원하지 않는 브라우저가 존재하여 주의해야 한다고 한다.

## CLS 방지

**로컬에 존재하는 이미지**에 대해 NextJS는 이미지 파일을 import하며 자동적으로 이미지의 너비와 높이를 결정한다.<br/>
이 값들은 이미지가 로드되는 동안 이미지가 그려질 자리를 미리 차지하며 `CLS(Cumulative Layout Shift)`를 방지한다.

반면, `src` 속성이 URL의 문자열로 전달되는 **원격(remote) 이미지**의 경우, 빌드 과정중 원격 파일에 접근할 수 없기 떄문에 `width`, `height` 등의 속성을 수동으로 직접 제공해야 한다.<br/>
또한 blur 옵션을 통해 blur image를 보여줄 수도 있다.<br/>
따라서 이를 통해 `placeholder`를 제공함으로써 CLS를 방지할 수 있다.

또한, 유저가 보는 화면에 없는 이미지까지 모두 로드하는 것은 성능에 악영향을 끼칠 수 있다.<br/>
따라서 유저가 보는 화면에 나타나기 전까지 이미지를 로드하지 않는 `Lazy Loading`을 사용하여 네트워크 요청에 대한 성능 최적화까지 이룰 수 있다.

물론, 기본적으로 `Lazy Loading`이 설정되어 있긴 하나, `priority`, `eager` 등의 옵션을 통해 이를 해제할 수 있다.
